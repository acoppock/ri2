<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Randomization Inference with ri2 • ri2</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Randomization Inference with ri2">
<meta property="og:description" content="ri2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ri2</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ri2_vignette.html">Randomization Inference with ri2</a>
    </li>
    <li>
      <a href="../articles/ri2_vs_ri.html">Comparing ri and ri2</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="ri2_vignette_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="ri2_vignette_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="ri2_vignette_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Randomization Inference with ri2</h1>
                        <h4 class="author">Alexander Coppock, Yale University</h4>
            
            <h4 class="date">2020-12-06</h4>
      
      
      <div class="hidden name"><code>ri2_vignette.Rmd</code></div>

    </div>

    
    
<p>Randomization inference (RI) is procedure for conducting hypothesis tests in randomized experiments. RI is useful for calculating the the probability that:</p>
<ul>
<li>a <strong>test statistic</strong> would be as extreme or more as observed…</li>
<li>if a particular <strong>null hypothesis</strong> were true…</li>
<li>over the all the possible randomizations that could have occurred acccording to the <strong>design</strong>.</li>
</ul>
<p>That probability is sometimes called a <span class="math inline">\(p\)</span>-value.</p>
<p>Randomization inference has a beautiful logic to it that may be more appealing to you than traditional hypothesis frameworks that rely on <span class="math inline">\(t\)</span>- or <span class="math inline">\(F\)</span>-tests. For a really lovely introduction to randomization inference, read Chapter 3 of Gerber and Green (2012).</p>
<p>The hard part of actually conducting randomization inference is the accounting. We need to enumerate all (or a random subset of all) the possible randomizations, correctly implement the null hypothesis, maybe figure out the inverse probability weights, then calculate the test statistics over and over. You can do this by hand with loops. The <code>ri2</code> package for r was written so that you don’t have to.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a></p>
<div id="basic-syntax" class="section level1">
<h1 class="hasAnchor">
<a href="#basic-syntax" class="anchor"></a>Basic syntax</h1>
<p>Gerber and Green (2012) describe a hypothetical experiment in which 2 of 7 villages are assigned a female council head and the outcome is the share of the local budget allocated to water sanitation. Their table 2.2 describes one way the experiment could have come out.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">table_2_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,
                        Y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">15</span>, <span class="fl">20</span>, <span class="fl">20</span>, <span class="fl">10</span>, <span class="fl">15</span>, <span class="fl">30</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>In order to conduct randomization inference, we need to supply 1) a test statistic, 2) a null hypothesis, and 3) a randomization procedure.</p>
<ol style="list-style-type: decimal">
<li>The test statistic. The <code>formula</code> argument of the <code>conduct_ri</code> function is similar to the regression syntax of r’s built-in <code>lm</code> function. Our test statistic is the coefficient on <code>Z</code> from a regression of <code>Y</code> on <code>Z</code>, or more simply, the difference-in-means.</li>
<li>The null hypothesis. The <code>sharp_hypothesis</code> argument of the <code>conduct_ri</code> function indicates that we are imagining a (hypothetical!) world in which the true difference in potential outcomes is exactly <code>0</code> for all units.</li>
<li>The randomization procedure: The <code>declare_ra</code> function from the <code>randomizr</code> package allows us to declare a randomization procedure. In this case, we are assigning <code>2</code> units to treatment out of <code>7</code> total units.</li>
</ol>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">ri2</span><span class="op">)</span></code></pre></div>
<pre><code>## Loading required package: randomizr</code></pre>
<pre><code>## Loading required package: estimatr</code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Declare randomization procedure</span>
<span class="va">declaration</span> <span class="op">&lt;-</span> <span class="fu">declare_ra</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">7</span>, m <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>

<span class="co"># Conduct Randomization Inference</span>
<span class="va">ri2_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/conduct_ri.html">conduct_ri</a></span><span class="op">(</span>
  formula <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>,
  declaration <span class="op">=</span> <span class="va">declaration</span>,
  sharp_hypothesis <span class="op">=</span> <span class="fl">0</span>,
  data <span class="op">=</span> <span class="va">table_2_2</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">ri2_out</span><span class="op">)</span></code></pre></div>
<pre><code>##   term estimate two_tailed_p_value
## 1    Z      6.5          0.3809524</code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ri2_out</span><span class="op">)</span></code></pre></div>
<p><img src="ri2_vignette_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
</div>
<div id="more-complex-designs" class="section level1">
<h1 class="hasAnchor">
<a href="#more-complex-designs" class="anchor"></a>More complex designs</h1>
<p>The <code>ri2</code> package has specific support for all the randomization procedures that can be described by the <code>randomizr</code> package:</p>
<ol style="list-style-type: decimal">
<li>Simple</li>
<li>Complete</li>
<li>Blocked</li>
<li>Clustered</li>
<li>Blocked and clustered</li>
</ol>
<p>See the <a href="https://declaredesign.org/r/randomizr/articles/randomizr_vignette.html">randomizr vignette</a> for specifics on each of these procedures.</p>
<p>By way of illustration, let’s take the blocked-and-clustered design from the <code>ri</code> package help files as an example. The call to <code>conduct_ri</code> is the same as it was before, but we need to change the random assignment declaration to accomodate the fact that clusters of two units are assigned to treatment and control (within three separate blocks). Note that in this design, the probabilities of assignment to treatment are <strong>not</strong> constant across units, but the <code>conduct_ri</code> function by default incorporates inverse probability weights to account for this design feature.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  Y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">8</span>, <span class="fl">6</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,
  Z <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span>,
  cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">6</span>, <span class="fl">6</span>, <span class="fl">7</span>, <span class="fl">7</span>, <span class="fl">8</span>, <span class="fl">8</span>, <span class="fl">9</span>, <span class="fl">9</span><span class="op">)</span>,
  block <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">6</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># clusters in blocks 1 and 3 have a 1/2 probability of treatment</span>
<span class="co"># but clusters in block 2 have a 2/3 probability of treatment</span>
<span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">block</span>, <span class="va">Z</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##      Z
## block 0 1
##     1 2 2
##     2 2 4
##     3 4 4</code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">block_m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fu"><a href="https://rdrr.io/r/base/tapply.html">tapply</a></span><span class="op">(</span><span class="va">Z</span>, <span class="va">block</span>, <span class="va">sum</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>

<span class="va">declaration</span> <span class="op">&lt;-</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">dat</span>,<span class="op">{</span>
    <span class="fu">declare_ra</span><span class="op">(</span>
      blocks <span class="op">=</span> <span class="va">block</span>,
      clusters <span class="op">=</span> <span class="va">cluster</span>,
      block_m <span class="op">=</span> <span class="va">block_m</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>

<span class="va">declaration</span></code></pre></div>
<pre><code>## Random assignment procedure: Blocked and clustered random assignment 
## Number of units: 18 
## Number of blocks: 3
## Number of clusters: 9
## Number of treatment arms: 2 
## The possible treatment categories are 0 and 1.
## The number of possible random assignments is 36.  
## The probabilities of assignment are NOT constant across units. Your analysis strategy must account for differential probabilities of assignment, typically by employing inverse probability weights.</code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ri2_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/conduct_ri.html">conduct_ri</a></span><span class="op">(</span>
  <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>,
  sharp_hypothesis <span class="op">=</span> <span class="fl">0</span>,
  declaration <span class="op">=</span> <span class="va">declaration</span>,
  data <span class="op">=</span> <span class="va">dat</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">ri2_out</span><span class="op">)</span></code></pre></div>
<pre><code>##   term estimate two_tailed_p_value
## 1    Z        2          0.1944444</code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ri2_out</span><span class="op">)</span></code></pre></div>
<p><img src="ri2_vignette_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
</div>
<div id="comparing-nested-models" class="section level1">
<h1 class="hasAnchor">
<a href="#comparing-nested-models" class="anchor"></a>Comparing nested models</h1>
<p>A traditional ANOVA hypothesis testing framework (implicitly or explicitly) compares two models, a restricted model and an unrestricted model, where the restricted model can be said to “nest” within the unrestricted model. The difference between models is summarized as an <span class="math inline">\(F\)</span>-statistic. We then compare the observed <span class="math inline">\(F\)</span>-statistic to a hypothetical null distribution that, under some possibly wrong assumptions can be said to follow an <span class="math inline">\(F\)</span>-distribution.</p>
<p>In a randomization inference framework, we’re happy to use the <span class="math inline">\(F\)</span>-statistic, but we want to construct a null distribution that corresponds to the distribution of <span class="math inline">\(F\)</span>-statistics that we would obtain if a particular (typically sharp) null hypothesis were true and we cycled through all the possible random assignments.</p>
<p>To do this in the <code>ri2</code> package, we need to supply model formulae to the <code>model_1</code> and <code>model_2</code> arguments of <code>conduct_ri</code>.</p>
<div id="three-arm-trial" class="section level2">
<h2 class="hasAnchor">
<a href="#three-arm-trial" class="anchor"></a>Three Arm Trial</h2>
<p>In this example, we consider a three-arm trial. We want to conduct the randomization inference analogue of an <span class="math inline">\(F\)</span>-test to see if any of the treatments influenced the outcome. We’ll consider the sharp null hypothesis that each unit would express exactly the same outcome regardless of which of the three arms it was assigned to.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="co"># three-arm trial, treat 33, 33, 34 or 33, 34, 33, or 34, 33, 33</span>
<span class="va">declaration</span> <span class="op">&lt;-</span> <span class="fu">declare_ra</span><span class="op">(</span>N <span class="op">=</span> <span class="va">N</span>, num_arms <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>

<span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu">conduct_ra</span><span class="op">(</span><span class="va">declaration</span><span class="op">)</span>
<span class="va">Y</span> <span class="op">&lt;-</span> <span class="fl">.9</span> <span class="op">*</span> <span class="fl">.2</span> <span class="op">*</span> <span class="op">(</span><span class="va">Z</span> <span class="op">==</span> <span class="st">"T2"</span><span class="op">)</span> <span class="op">+</span> <span class="op">-</span><span class="fl">.1</span> <span class="op">*</span> <span class="op">(</span><span class="va">Z</span> <span class="op">==</span> <span class="st">"T3"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">Z</span><span class="op">)</span>

<span class="va">ri2_out</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="../reference/conduct_ri.html">conduct_ri</a></span><span class="op">(</span>
    model_1 <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="fl">1</span>, <span class="co"># restricted model</span>
    model_2 <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, <span class="co"># unrestricted model</span>
    declaration <span class="op">=</span> <span class="va">declaration</span>,
    sharp_hypothesis <span class="op">=</span> <span class="fl">0</span>,
    data <span class="op">=</span> <span class="va">dat</span>
  <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ri2_out</span><span class="op">)</span></code></pre></div>
<p><img src="ri2_vignette_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">ri2_out</span><span class="op">)</span></code></pre></div>
<pre><code>##          term estimate two_tailed_p_value
## 1 F-statistic 1.013943               0.36</code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># for comparison</span>
<span class="fu"><a href="https://rdrr.io/r/stats/anova.html">anova</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span>, 
      <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Analysis of Variance Table
## 
## Model 1: Y ~ 1
## Model 2: Y ~ Z
##   Res.Df    RSS Df Sum of Sq      F Pr(&gt;F)
## 1     99 81.238                           
## 2     97 79.575  2    1.6636 1.0139 0.3666</code></pre>
</div>
<div id="interaction-terms" class="section level2">
<h2 class="hasAnchor">
<a href="#interaction-terms" class="anchor"></a>Interaction terms</h2>
<p>Oftentimes in an experiment, we’re interested the difference in average treatment effects by subgroups defined by pre-treatment characteristics. For example, we might want to know if the average treatment effect is larger for men or women. If we want to conduct a formal hypothesis test, we’re not interested in testing against the sharp null of no effect for any unit – we want to test against the null hypothesis of <strong>constant effects</strong>. In the example below, we test using the null hypothesis that all units have a constant effect equal to the estimated ATE. See Gerber and Green (2012) Chapter 9 for more information on this procedure.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="co"># two-arm trial, treat 50 of 100</span>
<span class="va">declaration</span> <span class="op">&lt;-</span> <span class="fu">declare_ra</span><span class="op">(</span>N <span class="op">=</span> <span class="va">N</span><span class="op">)</span>
<span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>
<span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu">conduct_ra</span><span class="op">(</span><span class="va">declaration</span><span class="op">)</span>
<span class="va">Y</span> <span class="op">&lt;-</span> <span class="fl">.9</span> <span class="op">+</span> <span class="fl">.2</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">+</span> <span class="fl">.1</span> <span class="op">*</span> <span class="va">X</span> <span class="op">+</span> <span class="op">-</span><span class="fl">.5</span> <span class="op">*</span> <span class="va">Z</span> <span class="op">*</span> <span class="va">X</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, <span class="va">Z</span><span class="op">)</span>

<span class="co"># Observed ATE</span>
<span class="va">ate_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
<span class="va">ate_hat</span></code></pre></div>
<pre><code>##         Z 
## 0.2049911</code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ri2_out</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="../reference/conduct_ri.html">conduct_ri</a></span><span class="op">(</span>
    model_1 <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">X</span>, <span class="co"># restricted model</span>
    model_2 <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">X</span> <span class="op">+</span> <span class="va">Z</span><span class="op">*</span><span class="va">X</span>, <span class="co"># unrestricted model</span>
    declaration <span class="op">=</span> <span class="va">declaration</span>,
    sharp_hypothesis <span class="op">=</span> <span class="va">ate_hat</span>,
    data <span class="op">=</span> <span class="va">dat</span>
  <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ri2_out</span><span class="op">)</span></code></pre></div>
<p><img src="ri2_vignette_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">ri2_out</span><span class="op">)</span></code></pre></div>
<pre><code>##          term estimate two_tailed_p_value
## 1 F-statistic 6.614815              0.006</code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># for comparison</span>
<span class="fu"><a href="https://rdrr.io/r/stats/anova.html">anova</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">X</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span>,
      <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Y</span> <span class="op">~</span> <span class="va">Z</span> <span class="op">+</span> <span class="va">X</span> <span class="op">+</span> <span class="va">Z</span><span class="op">*</span><span class="va">X</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Analysis of Variance Table
## 
## Model 1: Y ~ Z + X
## Model 2: Y ~ Z + X + Z * X
##   Res.Df    RSS Df Sum of Sq      F  Pr(&gt;F)  
## 1     97 96.061                              
## 2     96 89.869  1    6.1923 6.6148 0.01165 *
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<div id="arbitrary-test-statistics" class="section level1">
<h1 class="hasAnchor">
<a href="#arbitrary-test-statistics" class="anchor"></a>Arbitrary test statistics</h1>
<p>A major benefit of randomization inference is we can specify any scalar test statistic, which means we can conduct hypothesis tests for estimators beyond the narrow set for which statisticians have derived the variance. The <code>ri2</code> package accommodates this with the <code>test_function</code> argument of <code>conduct_ri</code>. You supply a function that takes a <code>data.frame</code> as its only argument and returns a scalar; <code>conduct_ri</code> does the rest!</p>
<div id="difference-in-variances" class="section level2">
<h2 class="hasAnchor">
<a href="#difference-in-variances" class="anchor"></a>Difference-in-variances</h2>
<p>For example, we can conduct a difference-in-variances test against the sharp null of no effect for any unit:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">declaration</span> <span class="op">&lt;-</span> <span class="fu">declare_ra</span><span class="op">(</span>N <span class="op">=</span> <span class="va">N</span>, m <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>

<span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu">conduct_ra</span><span class="op">(</span><span class="va">declaration</span><span class="op">)</span>
<span class="va">Y</span> <span class="op">&lt;-</span> <span class="fl">.9</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span>, sd <span class="op">=</span> <span class="fl">.25</span> <span class="op">+</span> <span class="fl">.25</span><span class="op">*</span><span class="va">Z</span><span class="op">)</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">Y</span>, <span class="va">Z</span><span class="op">)</span>

<span class="co"># arbitrary function of data</span>
<span class="va">test_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">Y</span><span class="op">[</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span><span class="op">(</span><span class="va">Y</span><span class="op">[</span><span class="va">Z</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># confirm it works</span>
<span class="fu">test_fun</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.1659939</code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ri2_out</span> <span class="op">&lt;-</span>
<span class="fu"><a href="../reference/conduct_ri.html">conduct_ri</a></span><span class="op">(</span>
  test_function <span class="op">=</span> <span class="va">test_fun</span>,
  declaration <span class="op">=</span> <span class="va">declaration</span>,
  assignment <span class="op">=</span> <span class="st">"Z"</span>,
  outcome <span class="op">=</span> <span class="st">"Y"</span>,
  sharp_hypothesis <span class="op">=</span> <span class="fl">0</span>,
  data <span class="op">=</span> <span class="va">dat</span>
<span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ri2_out</span><span class="op">)</span></code></pre></div>
<p><img src="ri2_vignette_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">ri2_out</span><span class="op">)</span></code></pre></div>
<pre><code>##                    term  estimate two_tailed_p_value
## 1 Custom Test Statistic 0.1659939                  0</code></pre>
</div>
<div id="balance-test" class="section level2">
<h2 class="hasAnchor">
<a href="#balance-test" class="anchor"></a>Balance Test</h2>
<p>Researchers sometimes conduct balance tests as a randomization check. Rather than conducting separate tests covariate-by-covariate, we might be interested in conducting an omnibus test.</p>
<p>Imagine we’ve got three covariates <code>X1</code>, <code>X2</code>, and <code>X3</code>. We’ll get a summary balance stat (the <span class="math inline">\(F\)</span>-statistic in this case), but it really could be anything!</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="va">declaration</span> <span class="op">&lt;-</span> <span class="fu">declare_ra</span><span class="op">(</span>N <span class="op">=</span> <span class="va">N</span><span class="op">)</span>

<span class="va">dat</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  X1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>,
  X2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="fl">.5</span><span class="op">)</span>,
  X3 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">3</span><span class="op">)</span>,
  Z <span class="op">=</span> <span class="fu">conduct_ra</span><span class="op">(</span><span class="va">declaration</span><span class="op">)</span>
  <span class="op">)</span>
  
<span class="va">balance_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">f</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
<span class="op">}</span>

<span class="co"># Confirm it works!</span>
<span class="fu">balance_fun</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></code></pre></div>
<pre><code>##    value 
## 1.401898</code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ri2_out</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="../reference/conduct_ri.html">conduct_ri</a></span><span class="op">(</span>
  test_function <span class="op">=</span> <span class="va">balance_fun</span>,
  declaration <span class="op">=</span> <span class="va">declaration</span>,
  assignment <span class="op">=</span> <span class="st">"Z"</span>,
  sharp_hypothesis <span class="op">=</span> <span class="fl">0</span>,
  data <span class="op">=</span> <span class="va">dat</span>
  <span class="op">)</span></code></pre></div>
<pre><code>## Warning in data.frame(est_sim = test_stat_sim, est_obs = test_stat_obs, : row
## names were found from a short variable and have been discarded</code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">ri2_out</span><span class="op">)</span></code></pre></div>
<p><img src="ri2_vignette_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">ri2_out</span><span class="op">)</span></code></pre></div>
<pre><code>##                    term estimate two_tailed_p_value
## 1 Custom Test Statistic 1.401898              0.261</code></pre>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># For comparison</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = Z ~ X1 + X2 + X3, data = dat)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -0.72059 -0.47237  0.02975  0.46984  0.71228 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  0.66696    0.12279   5.432 4.21e-07 ***
## X1           0.07399    0.05589   1.324    0.189    
## X2          -0.15557    0.10079  -1.543    0.126    
## X3          -0.02501    0.03054  -0.819    0.415    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 0.4995 on 96 degrees of freedom
## Multiple R-squared:  0.04197,    Adjusted R-squared:  0.01203 
## F-statistic: 1.402 on 3 and 96 DF,  p-value: 0.247</code></pre>
</div>
</div>
<div id="conclusion" class="section level1">
<h1 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h1>
<p>All of the randomization inference procedures had to, somehow or other, provide three pieces of information:</p>
<ol style="list-style-type: decimal">
<li>a test statistic (the difference-in-means, a regression coefficient, the difference-in-variances, an <span class="math inline">\(F\)</span>-statistic, etc.)</li>
<li>a sharp null hypothesis. The “sharp” in this context means that the null hypothesis has something specific to say about every unit’s potential outcomes. For example, the sharp null hypothesis of no effect for any unit means hypothesizes that each unit’s treatment and control potential outcome are identical.</li>
<li>A randomization procedure. We discussed simple, complete, blocked, clustered, and blocked and clustered designs, but these are not an exhaustive list of every kind of random assignment. Whatever your randomization procedure is, you have respect it!</li>
</ol>
<p>Randomization inference is a useful tool because we can conduct hypothesis tests without making additional assumptions about the distributions of outcomes or estimators. We can also do tests for arbitrary test statistics – we’re not just restricted to the set for which statisticians have worked out analytic hypothesis testing procedures.</p>
<p>A downside is that RI can be a pain to set up – the <code>ri2</code> package is designed to make this part easier.</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>The <code>ri2</code> package is the successor to the <code>ri</code> package, written by Peter Aronow and Cyrus Samii. <code>ri</code> was lightweight, fast, and correct for the set of tasks it handled. <code>ri2</code> hopes to be all that and more.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Alexander Coppock.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
